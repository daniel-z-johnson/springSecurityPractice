<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.practice.security.mapper.ProfileMapper">
    
    <resultMap id="ProfileResultMap" type="com.practice.security.model.Profile">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="favoriteTechnologies" column="favorite_technologies" 
                typeHandler="com.practice.security.mybatis.StringListTypeHandler"/>
        <result property="favoriteVideoGames" column="favorite_video_games" 
                typeHandler="com.practice.security.mybatis.StringListTypeHandler"/>
        <result property="favoriteBooks" column="favorite_books" 
                typeHandler="com.practice.security.mybatis.StringListTypeHandler"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>
    
    <insert id="insertProfile" parameterType="com.practice.security.model.Profile" 
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO profiles (user_id, favorite_technologies, favorite_video_games, favorite_books, created_at, updated_at)
        VALUES (#{userId}, 
                #{favoriteTechnologies, jdbcType=ARRAY, typeHandler=com.practice.security.mybatis.StringListTypeHandler}::text[],
                #{favoriteVideoGames, jdbcType=ARRAY, typeHandler=com.practice.security.mybatis.StringListTypeHandler}::text[],
                #{favoriteBooks, jdbcType=ARRAY, typeHandler=com.practice.security.mybatis.StringListTypeHandler}::text[],
                CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    </insert>
    
    <select id="findByUserId" resultMap="ProfileResultMap">
        SELECT id, user_id, favorite_technologies, favorite_video_games, favorite_books, created_at, updated_at
        FROM profiles
        WHERE user_id = #{userId}
    </select>
    
    <update id="updateProfile" parameterType="com.practice.security.model.Profile">
        UPDATE profiles
        SET favorite_technologies = #{favoriteTechnologies, typeHandler=com.practice.security.mybatis.StringListTypeHandler},
            favorite_video_games = #{favoriteVideoGames, typeHandler=com.practice.security.mybatis.StringListTypeHandler},
            favorite_books = #{favoriteBooks, typeHandler=com.practice.security.mybatis.StringListTypeHandler},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>
    
</mapper>
